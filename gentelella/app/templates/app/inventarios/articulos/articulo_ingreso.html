{% extends "app/base_site.html" %}

{% block title %} Listado de Compras {% endblock title %}

{% block stylesheets %}
{{ block.super }}
<link href="/static/vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
<link href="/static/vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
<link href="/static/vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
<link href="/static/vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
<link href="/static/vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">

<!--plugin autocompletado -->
<link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
<!-- plugin select2 -->
<link href="/static/vendors/select2/dist/css/select2.min.css" rel="stylesheet">
{% endblock stylesheets %}

{% block content %}

<!-- Cambio de html -->
<div class="right_col" role="main">

  <div class="row">

    <div class="clearfix"></div>

    <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>Ingreso de productor</h2>
          <div class="clearfix"></div>
        </div>

        <div class="x_content">
            
          <form class="form-horizontal form-label-left" method="POST" action="{% url 'reportes_compras' %}">
            {% csrf_token %}            
            <div class="form-group">                
                <label class="control-label col-md-4 col-sm-2 col-xs-12">Buscador de articulos: </label>
                <div class="input-group col-md-5 col-sm-10 col-xs-12">
                    <select class="form-control select2" style="width:100%;" name="articulo"></select>                    
                </div>                
            </div>
            <hr>         
          </form>   
          <div class="table-responsive">
            <table id="tabla_articulos" class="table table-striped jambo_table">
              <thead>
                <tr class="headings">
                  <th class="column-title text-center">Eliminar</th>
                  <th class="column-title text-center">Descripcion</th>
                  <th class="column-title text-center">Stock</th>
                  <th class="column-title text-center">Cantidad</th>
                  <th class="column-title text-center">Unidad</th>
                  <th class="column-title text-center">Proveedor</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="row">
              <form action="{% url 'imprimir_compras' %}" method="post" target="_blank">
                {% csrf_token %}
                <input id="pks_compras" hidden name="pks_compras" type="text" value="{% for c in compras %}{{ c.pk }} {% endfor %}" required><!--Siempre debe ir con un espacio. Ejem: '23 '-->
                <div class="col-md-12 col-sm-6 col-xs-12 text-center">
                  <button id="btnGenerarPDF" class="btn btn-primary"><i class="fa fa-file-pdf-o"></i> Generar PDF</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascripts %}
{{ block.super}}
<!-- Datatables -->
<script src="/static/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="/static/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>


<!-- jquery.inputmask -->
<script src="/static/vendors/jquery.inputmask/dist/min/jquery.inputmask.bundle.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<!-- plugin autocompletado -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<!-- select2 -->
<script src="/static/vendors/select2/dist/js/select2.min.js"></script>

<script>
  $(function () {
    $('.select2').select2({
        language: 'es'
    });
    var ingresoArticulos = {
        items:{
            articulos:[]
        },
        add: function (item) {
        this.items.articulos.push(item);
        this.list();
        },
        list: function () {
        tblProducts = $('#tabla_articulos').DataTable({
            responsive: true,
            autoWidth: false,
            destroy: true,
            data: this.items.articulos,
            columns: [                
                { "data": null }, //Contador de filas
                { "data": "descripcion" },
                { "data": "stock" },
                { "data": "cantidad" },
                { "data": "unidadMedida" },
                { "data": "idProveedor" }
            ],
            columnDefs: [
                {
                    targets: [-4],
                    class: 'text-center',
                    render: function (data, type, row) {
                        return '<span class="badge badge-secondary">' + data + '</span>';
                    }
                },
                {
                    targets: [0],
                    class: 'text-center',
                    orderable: false,
                    render: function (data, type, row) {
                        return '<a class="btn btn-danger btn-xs btn-flat" style="color: white;"><i class="fa fa-trash-o"></i></a>';
                    }
                },
                {
                    targets: [1,2,4,5],
                    class: 'text-center',
                    orderable: true,
                   
                },
                {
                    targets: [3],
                    class: 'text-center',
                    orderable: false,
                    render: function (data, type, row) {
                        return '<input type="text" name="cantidad" class="form-control" value="' + row.cantidad + '">';
                    }
                },                
            ],
            
            initComplete: function (settings, json) {

            }
        });
        },
    };

    $("#btnGenerarPDF").on("click", function () {
      if ($("#pks_compras").val() == "") {
        swal("Oops", "No se puede generar el reporte.", "error");  
      }
    });

    //** Declarar la tabla de Pesajes
    var tablaPesaje = $('#tabla_articulos').DataTable({
    data: [],
    columnDefs: [
    {
        "targets": -1,
        "data": null,
        "defaultContent": "<div class='a-center'><button class='btn btn-warning btn-xs tbEditarPesaje' title='Editar Pesaje'>" +
        "<i class='fa fa-pencil'></i></button><button class='btn btn-danger btn-xs tbEliminarPesaje' title='Eliminar Pesaje'>" +
        "<i class='fa fa-trash-o'></i></button></div>"
    }
    ],
    displayLength: 5,
    columns: [
        { "data": null }, //Contador de filas
        { "data": "descripcion" },
        { "data": "stock" },
        { "data": "cantidad" },
        { "data": "unidadMedida" },
        { "data": "idProveedor" }
    ],
    language: {
        "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
       }
    });



    //** autocompletado de los de articulos con ajax y select2
    $('select[name="articulo"]').select2({ 
        language: "es",
        allowClear: true,
        language: {
            inputTooShort: function () {
              return "Debe ingresar mas caracteres...";
            }
          },
        ajax: {
            delay: 250,
            type: 'POST',
            url: "{% url 'buscar_articulo_autocomplete' %}",
            data: function (params) {
                var queryParameters = {
                    term: params.term,
                    action: 'autocomplete'
                }
                return queryParameters;
            },
            processResults: function (data) {
                return {                    
                    results: data
                };
            },
        },
        placeholder: 'Ingrese una descripci√≥n',
        minimumInputLength: 3,        
        templateResult: formatRepo,
    }).on('select2:select', function (e) {        
        var data = e.params.data;
        if (!Number.isInteger(data.id)) {
            return false;
        }
        data.cantidad = 1;
        ingresoArticulos.add(data);
        console.log(ingresoArticulos)      
        $(this).val('').trigger('change.select2');
    });
    
  });
  //**funcion select para editar la respuesta del select2
    function formatRepo(repo) {
        if (repo.loading) {
            return repo.text;
        }

        if (!Number.isInteger(repo.id)) {
            return repo.text;
        }

        var option = $(
            '<div class="wrapper container">' +
            '<div class="row">' +
            '<div class="col-lg-11 text-left shadow-sm">' +
            //'<br>' +
            '<p style="margin-bottom: 0;">' +
            '<b>Nombre:</b> ' + repo.descripcion + '<br>' +
            '<b>Stock:</b> ' + repo.stock + '<br>' +
            '</p>' +
            '</div>' +
            '</div>' +
            '</div>');

        return option;
        }

</script>
{% endblock javascripts %}

