{% extends "app/base_site.html" %}
{% block stylesheets %}
  {{ block.super }}
  <link href="/static/vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
  <link href="/static/vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
  <link href="/static/vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
  <link href="/static/vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
  <link href="/static/vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">

  

  <!-- plugin de seleccion -->
  <link href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css" rel="stylesheet">
  <!-- plugin select2 -->
  <link href="/static/vendors/select2/dist/css/select2.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
{% endblock stylesheets %}


{% block title %} Facturación Compras {% endblock title %}


{% block content %}
  <div class="right_col" role="main">
    <div class="page-title">
      <div class="title_left">
        <h4>Pago Factura de Compras</h4>
      </div>       
    </div>
    
    <!-- /Form para empresa nueva -->
    <div class="row">
      <div class="col-md-8 col-xs-12">
          <div class="x_panel">
            <div class="x_title">
              <h2>Compras Pendientes</h2>              
              <div class="clearfix"></div>
            </div>
            <div class="x_content">
              <div class="form-group">
                <label class="control-label">Buscador de Productores:</label>
                <div class="input-group">
                  <input type="text" id="productor" class="form-control">
                  <span class="input-group-btn">
                    <button id="btnLimpiarProductor" type="button" class="btn btn-danger"><i
                    class="fa fa-times"></i></button>
                  </span>
                  </div>                
              </div>
              <div class="form-group">
                <label class="control-label">Buscador de Articulos:</label>
                <div class="input-group">
                  <input type="text" id="articulo" class="form-control select2">
                  <span class="input-group-btn">
                    <button id="btnLimpiarProductor" type="button" class="btn btn-danger"><i
                    class="fa fa-times"></i></button>
                  </span>
                  </div>                
              </div>

              <hr>
                          
              <div class="clearfix"></div>

              <!-- /Form para empresa nueva table-striped jambo_table bulk_action  -->             
              <div class="table-responsive">                 
                <table id="tabla_facturacion_compras" class=" table table-striped jambo_table" width="100%">
                  <thead>
                    <tr>
                      <th class="text-center"><input type="checkbox" id="select_all" name="select_invoice"></th>                      
                      <th >Fecha</th>
                      <th >Precio Unitario</th>
                      <th>Peso Neto (Kg)</th>
                      <th >Peso Neto (qq) </th>                      
                      <th>Fecha</th>
                      <th>Subtotal</th>                     
                    </tr>
                    
                  </thead>

                  <tbody>
                  </tbody>
                </table> 
                <div class="col-md-12 col-sm-12 col-xs-12">
                  <div class="btn-group  btn-group-center">
                    <div class="btn-group" role="group">
                      <button id="btnAgregarCompra" class="btn btn-success"><span class="fa fa-plus"></span>
                        Agregar Compra</button>
                    </div>
                  </div>
                </div>
              </div>
                                
              <div class="ln_solid"></div>
            
            </div>
          </div>

        </div>
        <div class="col-md-4 col-xs-12">
          <div class="x_panel">
            <div class="x_title">
              <h2>Facturación Compras</h2>
              
              <div class="clearfix"></div>
            </div>
            <div class="x_content">

              <div class="form-group">
                <label>Tipo de Documento:</label>
                  {{form.tipoDocumento}}
              </div>    
              <div class="form-group">
                <label>Número de Documento:</label>
                  {{form.numeroDocumento}}
              </div>
              <div class="form-group">
                <label>Fecha de compra:</label>
                  {{form.fechaEmision}}
              </div>
              <div class="form-group">
                <label>Productor:</label>
                  {{form.idProductor}}
              </div>              
              <div class="form-group">
                <label>SubTotal:</label>
                  {{form.cantidad}}
              </div>                           
              <div class="form-group">
                <label>SubTotal:</label>
                  {{form.preciounitario}}
              </div>
              <div class="form-group">
                <label>Total a Pagar:</label>
                  {{form.precioTotal}}
              </div>
              <div class="form-group">
                <label>Tipo de Pago:</label>
                  {{form.tipoPago}}
              </div>  

                   
                <div class="ln_solid"></div>                
              </div>

            </div>
          </div>        
        </div>               
  </div>
  
{% endblock content %}

{% block javascripts %}
  {{ block.super}}
    <!-- jquery.inputmask -->
  <script src="/static/vendors/jquery.inputmask/dist/min/jquery.inputmask.bundle.min.js"></script>
  <!-- datatables -->
  <script src="/static/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
  <script src="/static/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
  <script src="/static/vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
  <script src="/static/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>  
  <script src="/static/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>  
  <script src="/static/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script> 

  <script src="/static/vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
  <script src="/static/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
  <script src="/static/vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
 
  <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
  <!-- select2 -->
  <script src="/static/vendors/select2/dist/js/select2.min.js"></script>
    
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <script>
    $(function() {
      $("#nom_productor").val("");
      var tablaFacturaCompras;      
      listadoPesajesCompra();
      $('.select2').select2({
        theme: "bootstrap4",
        language: 'es'
      });
      //intanciacion de la tabla 
      function creartabla(){
        tablaFacturaCompras = $('#tabla_facturacion_compras').DataTable({
        //responsive: true,
        destroy: true,
        deferRender: true,
        ajax: {
          url: "/buscar_pesaje_compra",
          type: "POST",
          data: {
              'action':'buscar_pesaje_compra'
          },
        },
        scrollY:        300,
        scrollX:        true,
        scrollCollapse: true,
        paging:         false,
        fixedColumns:   {
            leftColumns: 2
        },

        columns: [          
            { "data": null }, //Contador de filas id,fechaPesaje,pesoBruto, PesoTara, pesoQuintales, pesoTotal, idCompra_id
            { "data": "fechaPesaje" },
            { "data": "pesoBruto" },
            { "data": "pesoNeto" },
            { "data": "pesoTara" },
            { "data": "pesoQuintales" },
            { "data": "pesoTotal" },
            { "data": null }, //Botones editar y eliminar
        ],
        columnDefs: [
          {
            "targets": -1,
            "data": null,
            "defaultContent": 
              "<i class='fa fa-trash-o'></i></button></div>"
            }],
            select: {
            style: multi,
            selector: 'td:first-child'
          },
        initComplete: function (settings, json) {

        }
    });

    $('#tabla_facturacion_compras tbody')
        var tr = tablaFacturaCompras.cell($(this).closest('td, li')).index();
        var data = tablaFacturaCompras.row(tr.row).data();
        console.log(data);
      }
     //Funcionalidad de autocompletado de los productores
    $("#productor").autocomplete({
      source: function(request,response){
        $.ajax({
          data: {
            'action': 'autocomplete',
            'term': request.term
          },
          url: window.location.pathname,
          type: "POST",
          success: function (data) {
            response(data);
          },
          error: function () {
            console.log("Hubo un problema.");
          }
        });
      },
      delay: 500,
      minLength: 3,
      select: function( event, ui ) {
        console.log(ui.item.nombres)
        $("#nom_productor").val(ui.item.nombres);
        $("#id_idProductor").select()
        .val(ui.item.nombres);
      }    
    });
    
    
    // Autocompletado de articulos con ajax y select2
    $('#articulo').select2({   
        language: "es",
        allowClear: true,
        language: {
            inputTooShort: function () {
              return "Debe ingresar mas caracteres...";
            }
          },
        ajax: {
            delay: 250,
            type: 'POST',
            url: window.location.pathname,
            data: function (params) {
                var queryParameters = {
                    term: params.term,
                    action: 'autocomplete'
                }
                return queryParameters;
            },
            processResults: function (data) {
                return {                    
                    results: data
                };
            },
        },
        placeholder: 'Ingrese una descripción',
        minimumInputLength: 3,
    });
   
    // Autocompletado de productor con ajax y select2
     $('#id_idProductor').select2({   
        language: "es",
        allowClear: true,
        language: {
            inputTooShort: function () {
              return "Debe ingresar mas caracteres...";
            }
          },
        ajax: {
            delay: 250,
            type: 'POST',
            url: "{% url 'buscar_productor_autocomplete' %}",
            data: function (params) {
                var queryParameters = {
                    term: params.term,
                    action: 'autocomplete'
                }
                return queryParameters;
            },
            processResults: function (data) {
                return {                    
                    results: data
                };
            },
        },
        placeholder: 'Ingrese una descripción',
        minimumInputLength: 3,
    });
   
    //Limpiar campos de busqueda de productores
    $('#btnLimpiarProductor').on('click', function () {
      $("#nom_productor").val("");
      $("#productor").val("");
      });

      
      function listadoPesajesCompra2(){        
      tablaFacturaCompras = $('#tabla_facturacion_compras').DataTable({
          responsive: true,
          processing: true,
          pageLength: 10,
          deferRender: true,   
          
         ajax:{
            url: "{% url 'buscar_pesaje_compra' %}",
            type: "POST",
            data: {
              'action': 'buscar_pesaje_compra',
            },
            dataSrc: ""
         },
          columnDefs: [ {
            targets: 0,
            data: "select",
            searchable: false,
            orderable: false,
            className: 'select-checkbox',
            width: "3%"
          },
          {targets: [1],class: 'text-center'},
          {targets: [2],class: 'text-center'},
          {targets: [3],class: 'text-center'},
          {targets: [4],class: 'text-center'},
          {targets: [5],class: 'text-center'},
          {targets: [6],class: 'text-center'},
          ],                            
         columns: [  
            { "data": null, defaultContent:'' },        
            { "data": "fechaPesaje" },
            { "data": "pesoBruto" },
            { "data": "pesoNeto" },
            { "data": "pesoTara" },
            { "data": "pesoQuintales" },
            { "data": "pesoTotal" },
          ],
          language: {
            "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json",
            select:{
              rows:{
                _: "%d filas seleccionadas",
                0: "",
                1: "1 fila seleccionada"
              }
            },
          },
          select: {
            style:    'multi',
            selector: 'td:first-child'
          },          
          order: [[ 1,'asc' ]],
          initComplete: function (settings, json) {
          },
       });
       
       

       $("#cantidad_total").text(calcularTotalPesaje());
       
       $('#tabla_facturacion_compras').on('click', '#select_all', function(){
         if($('#select_all:checked').val() === 'on'){
          tablaFacturaCompras.rows().select();
         }
         else{
          tablaFacturaCompras.rows().deselect();
         }
       })        



    }
    
    function listadoPesajesCompra1(){
      $.ajax({
        url: "/buscar_pesaje_compra",
        type: "get",
        dataType: 'json',        
        success: function(response){
          console.log(response);
          if($.fn.DataTable.isDataTable('#tabla_facturacion_compras')){
            console.log("entro");
            $('#tabla_facturacion_compras').DataTable().destroy();
          }
          
          $('#tabla_facturacion_compras tbody').html("");
          for(let i=0;i<response.length;i++){
            let fila = '<tr>';                   
            fila += '<td>' + response[i]["fields"]['fechaPesaje'] + '</td>';
            fila += '<td>' + response[i]["fields"]['fechaPesaje'] + '</td>';
            fila += '<td>' + response[i]["fields"]['pesoBruto'] + '</td>';            
            fila += '<td>' + response[i]["fields"]['pesoNeto'] + '</td>';
            fila += '<td>' + response[i]["fields"]['pesoTara'] + '</td>';
            fila += '<td>' + response[i]["fields"]['pesoQuintales'] + '</td>';
            fila += '<td>' + response[i]["fields"]['pesoTotal'] + '</td>';
            fila += '</tr>';
            $('#tabla_facturacion_compras tbody').append(fila);
            console.log(fila)
          }
                 
        
        },
        error: function(error){
          console.log(error)
        } 

      });
    } 
    
    function listadoPesajesCompra(){        
      tablaFacturaCompras = $('#tabla_facturacion_compras').DataTable({    
        destroy: true,
        deferRender: true,     
         ajax:{
            url: "{% url 'buscar_pesaje_compra' %}",
            type: "POST",
            data: {
              'action': 'buscar_pesaje_compra',
            },
            dataSrc: ""
         },
         columnDefs: [
          {
            data: "select",
            searchable: false,
            orderable: false,
            className: 'select-checkbox',
            orderable: false,
            targets: 0,            
            width: "3%"
          },
          {targets: [1],class: 'text-center'},
          {targets: [2],class: 'text-center'},
          {targets: [3],class: 'text-center'},
          {targets: [4],class: 'text-center'},
          {targets: [5],class: 'text-center'},
          {targets: [6],class: 'text-center'},
          ],                  
         columns: [  
            { "data": null, defaultContent:'' },        
            { "data": "fechaPesaje" },
            { "data": "pesoBruto" },
            { "data": "pesoNeto" },
            { "data": "pesoTara" },
            { "data": "pesoQuintales" },
            { "data": "pesoTotal" },
          ],
          language: {
            "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json",
            select:{
              rows:{
                _: "%d filas seleccionadas",
                0: "",
                1: "1 fila seleccionada"
              }
            },
          },
          select: {
            style:    'multi',
            selector: 'td:first-child'
          },                   
          order: [[ 1,'asc' ]],
          initComplete: function (settings, json) {
          },
       });
       
       

       $("#cantidad_total").text(calcularTotalPesaje());
       
       $('#tabla_facturacion_compras').on('click', '#select_all', function(){
         if($('#select_all:checked').val() === 'on'){
          tablaFacturaCompras.rows().select();
         }
         else{
          tablaFacturaCompras.rows().deselect();
         }
       })        



    }
    
     //** Calcular el Pesaje
    $("#btnAgregarCompra").on('click', function () {
      $('#cantidad').val(calcularTotalPesaje1());
      });
      
    
  //** Calcular Total de Pesajes  let rows_selected = tablaFacturaCompras.column(0).checkboxes. selected();
  function calcularTotalPesaje1() {
    let suma = 0;                
    $.each(tablaFacturaCompras.rows('.selected').nodes(), function(i, item){
      var data = tablaFacturaCompras.row(this).data();
      suma += parseFloat(data['pesoQuintales']);
    });       
    return suma.toFixed(2);
  }




   //** Calcular Total de Pesajes
   function calcularTotalPesaje() {
        let cantidadTotal = tablaFacturaCompras.rows().data();
        let suma = 0;
        for (let i = 0; i < cantidadTotal.length; i++) {
          suma += parseFloat(cantidadTotal[i].pesoQuintales);
        }
        return suma.toFixed(2);
      } 

    

   })
 </script>
 
 {% endblock javascripts %}
